<div class="theme-container">
    <div class="row justify-content-center">
        <div class="col-lg-10 pt-5">
            <mat-card class="p-5">
                <h1 class="mb-2 text-center page-title">{{ title }}</h1>
                <p class="mb-5 text-center font-weight-md sm-text"> 
                    Create your own feeds, choose your images and set what texts to display.
                </p>

                <mat-horizontal-stepper #stepper *ngIf="dealers || fetched_feed; else spinner" linear (selectionChange)="selectionChange($event)">
                    <!-- Begin: Step 1 -->
                    <mat-step>
                        <div class="row justify-content-center pt-4">
                            <div class="col-lg-8">
                                <form [formGroup]="new_feed_form" class="full-width mb-4" #formDirective="ngForm">
                                    <mat-form-field class="full-width" appearance="fill">
                                        <mat-label>Feed Title</mat-label>
                                        <input matInput formControlName="feed_title">
                                    </mat-form-field>

                                    <mat-form-field class="full-width" appearance="fill">
                                        <mat-label>Description</mat-label>
                                        <input matInput formControlName="description">
                                    </mat-form-field>

                                    <mat-form-field class="full-width" appearance="fill">
                                        <mat-label>Assign to Dealer</mat-label>
                                        <input type="text"
                                            formControlName="assign_to" 
                                            placeholder="Choose a Dealer"
                                            aria-label="Dealer"
                                            matInput
                                            [matAutocomplete]="auto">
                                        <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete">
                                            <mat-option *ngFor="let option of filtered_options | async" [value]="option.businessName">
                                                {{ option.businessName }}
                                            </mat-option>
                                        </mat-autocomplete>
                                    </mat-form-field>
                                </form>

                                <button mat-button mat-raised-button matStepperNext class="theme-btn" [disabled]="!new_feed_form.valid">
                                    <span class="button-label">Next</span>
                                    <span class="fas fa-long-arrow-alt-right ml-2"></span>
                                </button>
                            </div>
                        </div>
                        <ng-template matStepLabel>Feed Information</ng-template>
                    </mat-step>
                    <!-- End: Step 1 -->

                    <!-- Begin: Step 2 -->
                    <mat-step>
                        <ng-template matStepLabel>Feed Content</ng-template>
                        
                        <div class="bg-gray mt-5 p-4" *ngIf="selected_dealer && new_feed_form.valid; else no_dealer_selected">
                            <mat-accordion #draggables id="draggables">
                                <mat-expansion-panel *ngFor="let f of feed_items; let i = index" hideToggle class="feed-item" [attr.data-id]="f.image.content_id">
                                    <mat-expansion-panel-header class="align-items-center">
                                        <mat-panel-description class="sm-text">
                                            <div class="d-flex w-100">
                                                <div class="flex-even">
                                                    {{ i + 1 }} - {{ f.context.heading }}
                                                </div>
    
                                                <div class="text-right">
                                                    <button class="delete-item" (click)="removeFeedItem(f)"><span class="fas fa-times"></span></button>
                                                </div>
                                            </div>
                                        </mat-panel-description>
                                    </mat-expansion-panel-header>
    
                                    <div class="row w-100 align-items-start">
                                        <div class="col-lg-2 text-center">
                                            <div class="image-wrapper">
                                                <img class="image-w-100 mb-1" [src]="f.image.preview_url" alt="f.image.filename">
                                                <div class="overlay" [title]="f.image.filename">
                                                    <span class="sm-text font-weight-bold">{{ f.image.filename | filename }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-10">
                                            <div class="row">
                                                <div class="col-lg-6">
                                                    <mat-form-field class="full-width" appearance="fill">
                                                        <mat-label>Heading</mat-label>
                                                        <input matInput type="text" [value]="f.context.heading" [(ngModel)]="f.context.heading">
                                                    </mat-form-field>
                                                </div>
        
                                                <div class="col-lg-6">
                                                    <mat-form-field class="full-width" appearance="fill">
                                                        <mat-label>Duration: Default is 5 seconds</mat-label>
                                                        <input matInput type="text" [value]="f.context.duration" [(ngModel)]="f.context.duration" (change)="apply_to_all_btn_status = !apply_to_all_btn_status">
                                                        <button class="apply-to-all-btn" *ngIf="apply_to_all_btn_status" [ngClass]="apply_to_all_btn_status ? 'active' : ''" (click)="applyDurationToAll(f.context.duration);">
                                                            Apply to all items
                                                        </button>
                                                    </mat-form-field>
                                                </div>
            
                                                <div class="col-lg-12">
                                                    <mat-form-field class="full-width" appearance="fill">
                                                        <mat-label>Paragraph</mat-label>
                                                        <input matInput type="text" [value]="f.context.paragraph" [(ngModel)]="f.context.paragraph">
                                                    </mat-form-field>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </mat-expansion-panel>
                            </mat-accordion>

                            <div class="row justify-content-center pt-5">
                                <div class="border-dash col-lg-10 text-center p-5 position-relative">
                                    <h3 class="mb-4" *ngIf="feed_items.length == 0">Add images to get started.</h3>
                                    <button mat-button mat-raised-button class="theme-btn mr-2" (click)="openMediaLibraryModal()">
                                        <span class="button-label">Add Images</span>
                                        <span class="fas fa-images ml-2"></span>
                                    </button>

                                    <button *ngIf="feed_items.length > 0" mat-button mat-raised-button matStepperNext class="theme-btn" (click)="structureFeedToGenerate()">Next</button>
                                </div>
                            </div>
                        </div>
                    </mat-step>
                    <!-- End: Step 2 -->

                    <!-- Begin: Step 3 -->
                    <mat-step>
                        <ng-template matStepLabel>Preview and Save</ng-template>
                        <div *ngIf="feed_items.length > 0; else no_feed_content">
                            <div class="row mb-5 mt-5">
                                <div class="col-lg-12 text-center">
                                    <h3>Here's a preview of your customized feed.</h3>
                                    <p class="sm-text">You can edit your generated feed by going back one step above.</p>
                                </div>
                            </div>
    
                            <div class="row justify-content-center" *ngIf="selected_index === 2">
                                <div class="col-lg-8 position-relative">
                                    <div class="loading-overlay" *ngIf="saving">
                                        <app-spinner [diameter]="70"></app-spinner>
                                    </div>
                                    <app-feed-demo [feed_items]="feed_items"></app-feed-demo>
                                    <button *ngIf="feed_items.length > 0" mat-button mat-raised-button class="theme-btn mt-4" (click)="saveGeneratedFeed()" [disabled]="saving">Save</button>
                                </div>
                            </div>
                        </div>
                    </mat-step>
                    <!-- End: Step 3 -->
                </mat-horizontal-stepper>

                <ng-template #no_feed_content>
                    <div class="bg-gray p-5 text-center mt-5">
                        <h3>No Feed Items Available, Go Back to Step 2 - Feed Content</h3>
                    </div>
                </ng-template>

                <ng-template #no_dealer_selected>
                    <div class="bg-gray p-5 text-center mt-5">
                        <h3>Feed information is not valid, Go Back to Step 1 - Feed Information</h3>
                    </div>
                </ng-template>

                <ng-template #spinner>
                    <div class="py-5">
                        <app-spinner></app-spinner>
                    </div>
                </ng-template>
            </mat-card>
        </div>
    </div>
</div>